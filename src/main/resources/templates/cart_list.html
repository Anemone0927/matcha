<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚«ãƒ¼ãƒˆä¸€è¦§ | OshiGiftBox</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* --- å…¨ã¦ã®è¦ç´ ã« box-sizing: border-box ã‚’é©ç”¨ã—ã¾ã™ --- */
        * {
            box-sizing: border-box;
        }

        /* ------------------------------------
            1. å…±é€šãƒ™ãƒ¼ã‚¹ã‚¹ã‚¿ã‚¤ãƒ«
        ------------------------------------ */
        body {
            background-color: #ffd9ef;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #333;
            margin: 0;
            padding: 0;
        }

        main {
            padding: 20px;
            max-width: 900px;
            margin: 0 auto;
        }

        /* --- Header Style --- */
        header {
            background-color: #159450;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
            margin-bottom: 20px;
        }

        header .home-icon,
        header .user-icon {
            width: 40px;
            height: 40px;
            border-radius: 20px;
            cursor: pointer;
            transition: transform 0.3s;
        }

        header .home-icon:hover,
        header .user-icon:hover {
            transform: scale(1.1);
        }

        header h1 {
            color: white;
            font-size: 1.8em;
            margin: 0 0 0 15px;
            flex-grow: 1;
        }

        header .left {
            display: flex;
            align-items: center;
        }

        /* ------------------------------------
            2. ãƒšãƒ¼ã‚¸å›ºæœ‰ã®ã‚¹ã‚¿ã‚¤ãƒ« (ã‚«ãƒ¼ãƒˆä¸€è¦§)
        ------------------------------------ */
        h1 {
            color: #a1835d;
            text-align: center;
            margin-bottom: 30px;
            margin-top: 0;
        }

        /* ç™½ã„ãƒœãƒƒã‚¯ã‚¹ã®ã‚¹ã‚¿ã‚¤ãƒ« (ãƒªã‚¹ãƒˆå…¨ä½“ã‚’å›²ã‚€) */
        .list-card {
            background-color: #fff;
            width: 100%;
            max-width: 750px;
            margin: 0 auto;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(122, 111, 219, 0.2);
            text-align: center;
        }

        .list-card h2 {
            color: #7a6fdb;
            text-align: center;
            font-size: 1.5em;
            margin-top: 0;
            margin-bottom: 20px;
        }

        /* ãƒ¬ã‚¸ã«é€²ã‚€ãƒœã‚¿ãƒ³ */
        .checkout-btn {
            display: inline-block;
            background-color: #7a6fdb;
            color: white;
            padding: 12px 25px;
            margin-top: 25px; /* åˆè¨ˆé‡‘é¡ã¨ã®é–“ã«å°‘ã—ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç©ºã‘ã‚‹ */
            margin-bottom: 0; /* list-cardã®paddingã§ã‚¹ãƒšãƒ¼ã‚¹ã‚’å–ã‚‹ãŸã‚ */
            border-radius: 10px;
            text-decoration: none;
            font-weight: 700;
            font-size: 1.1em;
            transition: background-color 0.3s;
            border: none;
            cursor: pointer;
        }

        .checkout-btn:hover {
            background-color: #5d52b4;
        }

        /* å•†å“ãƒªã‚¹ãƒˆ (ul) ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #productList {
            list-style: none;
            padding: 0;
            margin: 0;
            text-align: left;
        }

        /* å€‹åˆ¥å•†å“ã‚¢ã‚¤ãƒ†ãƒ  (li) ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #productList li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
        }

        #productList li:last-child {
            border-bottom: none;
        }

        .product-info {
            display: flex;
            align-items: center;
            flex-grow: 1;
            gap: 15px;
        }

        .product-info strong {
            font-size: 1.1em;
            /* ã‚«ãƒ¼ãƒˆã§ã¯å“åãŒé•·ããªã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€flex-growã§å¯¾å¿œ */
            flex-grow: 1;
            min-width: 150px; 
        }

        .product-price-subtotal {
            min-width: 120px;
            text-align: right;
            /* å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’è€ƒæ…®ã—ã¦èª¿æ•´ */
            margin-right: 15px;
        }

        /* ç”»åƒã‚³ãƒ³ãƒ†ãƒŠã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .product-image-container {
            width: 60px;
            height: 60px;
            overflow: hidden;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
        }

        .product-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        /* æ•°é‡ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 5px;
            min-width: 120px;
            justify-content: center;
        }

        .quantity-controls button {
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 30px;
            height: 30px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .quantity-controls button:hover {
            background-color: #e0e0e0;
        }

        .quantity-input {
            width: 40px;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 5px 2px;
            font-size: 1em;
        }

        /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ï¼ˆå‰Šé™¤ã®ã¿ï¼‰ã®ã‚³ãƒ³ãƒ†ãƒŠ */
        .item-controls {
            display: flex;
            align-items: center;
            min-width: 80px; /* å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚µã‚¤ã‚ºã«åˆã‚ã›ã‚‹ */
            justify-content: flex-end;
            flex-shrink: 0;
        }
        
        /* å‰Šé™¤ãƒœã‚¿ãƒ³ */
        .delete-btn {
            background-color: #ff7f7f;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s;
            font-weight: 600;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .delete-btn:hover {
            background-color: #e55e5e;
        }

        /* åˆè¨ˆé‡‘é¡è¡¨ç¤ºã‚¨ãƒªã‚¢ */
        #totalPriceContainer {
            border-top: 3px solid #7a6fdb;
            padding-top: 20px;
            margin-top: 20px;
            text-align: right;
        }

        #totalPriceContainer p {
            margin: 5px 0;
            font-size: 1.2em;
            font-weight: 700;
        }

        #totalPriceContainer #grandTotal {
            font-size: 1.8em;
            color: #ff3366;
        }

        /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ */
        #messageBox {
            text-align: center;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 8px;
            display: none;
            font-weight: 600;
        }

        .success {
            background-color: #e6ffe6;
            color: #4CAF50;
            border: 1px solid #4CAF50;
        }

        .error {
            background-color: #ffe6e6;
            color: #f44336;
            border: 1px solid #f44336;
        }

        /* ------------------------------------
            3. ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ (å‰Šé™¤ãƒœã‚¿ãƒ³ã«åˆã‚ã›ã¦èª¿æ•´)
        ------------------------------------ */
        @media screen and (max-width: 768px) {
            .product-info strong {
                min-width: 100px;
            }

            .product-price-subtotal {
                min-width: 80px;
                margin-right: 10px; 
            }

            .quantity-controls {
                min-width: 100px;
            }

            .item-controls {
                min-width: 60px; /* å‰Šé™¤ãƒœã‚¿ãƒ³åˆ†ã«èª¿æ•´ */
            }
        }

        @media screen and (max-width: 600px) {
            .list-card {
                padding: 15px;
            }

            /* 1è¡Œã ã£ãŸè¦ç´ ã‚’è¤‡æ•°è¡Œã«æŠ˜ã‚Šè¿”ã™ */
            #productList li {
                flex-direction: row;
                flex-wrap: wrap;
                gap: 10px;
            }

            .product-info {
                width: 100%;
                justify-content: flex-start;
                margin-bottom: 10px;
                gap: 10px;
            }

            .product-info strong {
                min-width: auto;
                flex-grow: 1;
            }

            .product-image-container {
                order: -1;
                margin-right: 5px;
            }

            /* æ•°é‡ã¨å°è¨ˆã¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ¨ªä¸¦ã³ã« */
            /* item-controlsã¯å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã¿ãªã®ã§ã€æ¨ªå¹…ã¯å°ã•ãã¦è‰¯ã„ */
            .quantity-controls,
            .product-price-subtotal {
                /* 2åˆ—ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ä½œæˆ (æ®‹ã‚Šã®ã‚¹ãƒšãƒ¼ã‚¹ã¯infoã«ä»»ã›ã‚‹) */
                width: 40%;
                margin: 0;
                padding: 0;
                display: flex;
                justify-content: flex-start;
                align-items: center;
            }
            
            .item-controls {
                width: 20%;
                justify-content: flex-end;
            }


            .product-price-subtotal {
                text-align: right;
                justify-content: flex-end;
            }

            .delete-btn {
                padding: 6px 8px;
            }
        }

        /* ------------------------------------
            4. Custom Modal Style
        ------------------------------------ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-content {
            background-color: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 25px rgba(122, 111, 219, 0.4);
            max-width: 400px;
            width: 100%;
            text-align: center;
        }

        #modalMessage {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 25px;
            color: #7a6fdb;
        }

        .modal-actions {
            display: flex;
            justify-content: space-around;
            gap: 15px;
        }

        .modal-actions button {
            flex-grow: 1;
            padding: 12px 15px;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
            font-size: 1em;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .confirm-btn {
            background-color: #ff7f7f;
            color: white;
        }

        .confirm-btn:hover {
            background-color: #e55e5e;
            transform: translateY(-1px);
        }

        .cancel-btn {
            background-color: #f0f0f0;
            color: #555;
        }

        .cancel-btn:hover {
            background-color: #e0e0e0;
            transform: translateY(-1px);
        }
    </style>
</head>

<body>
    <header>
        <div class="left">
            <a th:href="@{/}" href="/">
                <img src="/images/homebotan.jpg" alt="ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã¸æˆ»ã‚‹" class="home-icon" />
            </a>
            <h1>OshiGiftBox</h1>
        </div>
        <div class="user-links">
            <a th:href="@{/users/auth_select}">
                <img src="/images/yuza.jpg" alt="ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²" class="user-icon" />
            </a>
        </div>
    </header>

    <main>
        <h1>ã‚«ãƒ¼ãƒˆä¸€è¦§</h1>

        <div class="list-card">
            <h2>ğŸ›’ ã‚«ãƒ¼ãƒˆå†…ã‚¢ã‚¤ãƒ†ãƒ ãƒªã‚¹ãƒˆ</h2>

            <div id="messageBox"></div>

            <ul id="productList">
                <p style="text-align: center; color: #7a6fdb; font-weight: 600;">ã‚«ãƒ¼ãƒˆæƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
            </ul>

            <div id="totalPriceContainer" style="display: none;">
                <p>å°è¨ˆï¼ˆç¨æŠœï¼‰ï¼š<span id="subTotal">0</span>å††</p>
                <p>åˆè¨ˆé‡‘é¡ï¼ˆç¨è¾¼ï¼‰ï¼š<span id="grandTotal">0</span>å††</p>
            </div>
            
            <!-- ä¿®æ­£: åˆè¨ˆé‡‘é¡ã®ä¸‹ã€ä¸­å¤®ã«é…ç½® -->
            <button onclick="proceedToCheckout()" class="checkout-btn">
                ãƒ¬ã‚¸ã«é€²ã‚€ <i class="fas fa-arrow-circle-right"></i>
            </button>
        </div>
    </main>

    <div id="deleteModal" class="modal-overlay">
        <div class="modal-content">
            <p id="modalMessage">ã“ã®å•†å“ã‚’ã‚«ãƒ¼ãƒˆã‹ã‚‰å–ã‚Šå‡ºã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</p>
            <div class="modal-actions">
                <button id="modalConfirmBtn" class="confirm-btn">å–ã‚Šå‡ºã™</button>
                <button id="modalCancelBtn" class="cancel-btn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>

    <script>
        // å‰Šé™¤å‡¦ç†ã®çŠ¶æ…‹ã‚’ä¿æŒã™ã‚‹ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let itemToRemoveId = null;
        let itemToRemoveName = null;

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºé–¢æ•°
        function displayMessage(message, type = 'success') {
            const box = document.getElementById('messageBox');
            box.textContent = message;
            box.className = '';
            box.classList.add(type);
            box.style.display = 'block';
            // 3ç§’å¾Œã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¶ˆã™
            setTimeout(() => {
                box.style.display = 'none';
            }, 3000);
        }

        // ----------------------------------------------------
        // ã‚«ãƒ¼ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã®æ•°é‡ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        // ----------------------------------------------------
        async function updateQuantity(id, newQuantity) {
            // æ•°é‡ãŒ0ä»¥ä¸‹ã®å ´åˆã¯å‰Šé™¤ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            if (newQuantity <= 0) {
                const currentItem = document.querySelector(`#productList li[data-item-id="${id}"] strong`);
                const name = currentItem ? currentItem.textContent.replace(/^\d+\.\s*/, '') : 'ã“ã®ã‚¢ã‚¤ãƒ†ãƒ ';

                // æ•°é‡ãŒ0ä»¥ä¸‹ã«ãªã£ãŸå ´åˆã¯ã€å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
                showDeleteModal(id, name);
                return;
            }

            // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ã®æ›´æ–°å‡¦ç†ã‚’æƒ³å®š
            try {
                const response = await fetch(`/api/cart/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        quantity: newQuantity
                    })
                });

                if (response.ok) {
                    // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æœ€æ–°ã®ã‚«ãƒ¼ãƒˆæƒ…å ±ã‚’å–å¾—ã—ç›´ã™ï¼ˆå°è¨ˆãƒ»åˆè¨ˆãŒå¤‰ã‚ã‚‹ãŸã‚ï¼‰
                    fetchAndDisplayCartItems();
                } else if (response.status === 400) {
                    const errorText = await response.text();
                    displayMessage(`æ•°é‡æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ${errorText}`, 'error');
                } else {
                    const errorText = await response.text();
                    throw new Error(`[${response.status}] æ•°é‡æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ${errorText}`);
                }
            } catch (err) {
                console.error('æ•°é‡æ›´æ–°ã‚¨ãƒ©ãƒ¼:', err);
                displayMessage(`æ•°é‡æ›´æ–°å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚`, 'error');
            }
        }

        // +/- ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ãƒãƒ³ãƒ‰ãƒ©
        function handleQuantityChange(id, change) {
            const inputElement = document.querySelector(`#productList li[data-item-id="${id}"] .quantity-input`);
            let currentQuantity = parseInt(inputElement.value, 10);
            let newQuantity = currentQuantity + change;

            // UIã‚’å…ˆã«æ›´æ–°ã—ã¦UXã‚’å‘ä¸Šã•ã›ã‚‹ï¼ˆã™ãã«ã‚µãƒ¼ãƒãƒ¼é€šä¿¡ã‚’è¡Œã†ï¼‰
            if (newQuantity >= 1) {
                inputElement.value = newQuantity;
            }

            // æ•°é‡ãŒ0ä»¥ä¸‹ã«ãªã£ãŸå ´åˆã‚‚å‡¦ç†ã¯ updateQuantity ã«ä»»ã›ã‚‹
            updateQuantity(id, newQuantity);
        }

        // å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        function showDeleteModal(id, name) {
            itemToRemoveId = id;
            itemToRemoveName = name;

            const modal = document.getElementById('deleteModal');
            const message = document.getElementById('modalMessage');

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¨­å®š
            message.innerHTML = `<strong>${name}</strong>ã‚’ã‚«ãƒ¼ãƒˆã‹ã‚‰å–ã‚Šå‡ºã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`;

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            modal.style.display = 'flex';
        }

        // å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’éè¡¨ç¤º
        function hideDeleteModal() {
            document.getElementById('deleteModal').style.display = 'none';
            itemToRemoveId = null;
            itemToRemoveName = null;
        }

        // å‰Šé™¤ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã¨ãã®å‡¦ç† (ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º)
        function removeCartItem(id, name) {
            showDeleteModal(id, name);
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã§ã€Œå–ã‚Šå‡ºã™ã€ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã¨ãã®å®Ÿéš›ã®å‰Šé™¤å‡¦ç†
        async function confirmDelete() {
            if (itemToRemoveId === null) return;

            const id = itemToRemoveId;
            const name = itemToRemoveName;

            hideDeleteModal(); // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹

            try {
                // ã‚«ãƒ¼ãƒˆAPIã‚’å©ã
                const response = await fetch(`/api/cart/${id}`, {
                    method: 'DELETE' // ğŸ‘ˆ DELETE ã«å¤‰æ›´
                });

                if (response.ok) {
                    // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰è¿”ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æœ¬æ–‡ã‚’å–å¾—ï¼ˆã“ã“ã§ã¯ãƒ†ã‚­ã‚¹ãƒˆå¿œç­”ã‚’æƒ³å®šï¼‰
                    const successMessage = await response.text().catch(() => `${name}ã‚’ã‚«ãƒ¼ãƒˆã‹ã‚‰å–ã‚Šå‡ºã—ã¾ã—ãŸã€‚`);

                    displayMessage(successMessage, 'success');
                    fetchAndDisplayCartItems(); // ãƒªã‚¹ãƒˆã‚’æ›´æ–°
                } else {
                    const errorText = await response.text();
                    throw new Error(`[${response.status}] ${errorText || 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼'}`);
                }
            } catch (err) {
                console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', err);
                displayMessage(`å‰Šé™¤å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚`, 'error');
            }
        }


        // ----------------------------------------------------
        // ã‚«ãƒ¼ãƒˆãƒªã‚¹ãƒˆã‚’å–å¾—ã—è¡¨ç¤ºã™ã‚‹å‡¦ç†
        // ----------------------------------------------------
        async function fetchAndDisplayCartItems() {
            const list = document.getElementById('productList');
            const totalContainer = document.getElementById('totalPriceContainer');
            list.innerHTML = '<p style="text-align: center; color: #7a6fdb; font-weight: 600;">ã‚«ãƒ¼ãƒˆæƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>';
            totalContainer.style.display = 'none'; // åˆè¨ˆã‚¨ãƒªã‚¢ã‚’ä¸€æ—¦éè¡¨ç¤º

            let data = [];
            let subTotal = 0;
            const TAX_RATE = 0.10; // 10%

            try {
                // ã‚µãƒ¼ãƒãƒ¼ã®APIã‚’å©ã
                const response = await fetch('/api/cart');
                if (!response.ok) {
                    const errorDetail = await response.text();
                    throw new Error(`ã‚«ãƒ¼ãƒˆæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚è©³ç´°: ${errorDetail}`);
                }
                // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰è¿”ã•ã‚ŒãŸJSONãƒ‡ãƒ¼ã‚¿ï¼ˆã‚¢ã‚¤ãƒ†ãƒ ãƒªã‚¹ãƒˆï¼‰ã‚’æƒ³å®š
                data = await response.json();
            } catch (err) {
                console.error('ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', err);
                displayMessage(`ã‚«ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚µãƒ¼ãƒãƒ¼ã¨ã®æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`, 'error');
                list.innerHTML = `<p style="text-align: center; color: #f44336; padding: 15px;">ã‚¨ãƒ©ãƒ¼: ${err.message}</p>`;
                document.querySelector('.checkout-btn').style.display = 'none';
                return;
            }

            list.innerHTML = ''; // ãƒ­ãƒ¼ãƒ‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢

            const checkoutButton = document.querySelector('.checkout-btn');

            if (data.length === 0) {
                // ãƒ‡ãƒ¼ã‚¿ãŒç©ºã®å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                list.innerHTML = '<p style="text-align: center; color: #7a6fdb; font-weight: 600; padding: 15px;">ã‚«ãƒ¼ãƒˆã«ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                checkoutButton.style.display = 'none'; // ã‚«ãƒ¼ãƒˆãŒç©ºã®å ´åˆã¯ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
                return;
            }

            checkoutButton.style.display = 'inline-block'; // ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚‹å ´åˆã¯ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º

            data.forEach((item, index) => {
                // å°è¨ˆã‚’è¨ˆç®—
                const itemSubtotal = item.price * item.quantity;
                subTotal += itemSubtotal;

                const li = document.createElement('li');
                li.dataset.itemId = item.id; // æ•°é‡æ›´æ–°ãªã©ã§ä½¿ç”¨ã™ã‚‹ãŸã‚ã«IDã‚’ä»˜ä¸

                // ç”»åƒURLãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã®ä»£æ›¿ç”»åƒ
                const imageSrc = item.imagePath ?
                    item.imagePath :
                    `https://placehold.co/60x60/cccccc/ffffff?text=No+Img`;

                li.innerHTML = `
                    <div class="product-info">
                        <div class="product-image-container">
                            <img src="${imageSrc}"
                                alt="${item.name}ã®ç”»åƒ"
                                onerror="this.onerror=null;this.src='https://placehold.co/60x60/cccccc/ffffff?text=No+Img';">
                        </div>
                        <strong>${index + 1}. ${item.name}</strong>
                    </div>

                    <div class="quantity-controls">
                        <button type="button" onclick="handleQuantityChange(${item.id}, -1)">-</button>
                        <input type="number"
                            class="quantity-input"
                            value="${item.quantity}"
                            min="1"
                            onchange="updateQuantity(${item.id}, this.value)"
                            aria-label="${item.name}ã®æ•°é‡">
                        <button type="button" onclick="handleQuantityChange(${item.id}, 1)">+</button>
                    </div>

                    <div class="product-price-subtotal">
                        <div style="font-size: 0.8em; color: #777;">${item.price.toLocaleString()}å†† / å€‹</div>
                        <div style="font-weight: 700; color: #333; margin-top: 3px;">
                            å°è¨ˆ: ${itemSubtotal.toLocaleString()}å††
                        </div>
                    </div>

                    <div class="item-controls">
                        <button type="button"
                            class="delete-btn"
                            onclick="removeCartItem(${item.id}, '${item.name}')">å‰Šé™¤</button>
                    </div>
                `;
                list.appendChild(li);
            });

            // åˆè¨ˆé‡‘é¡ã‚’æ›´æ–°
            const tax = Math.round(subTotal * TAX_RATE);
            const grandTotal = subTotal + tax;

            document.getElementById('subTotal').textContent = subTotal.toLocaleString();
            document.getElementById('grandTotal').textContent = grandTotal.toLocaleString();
            totalContainer.style.display = 'block';
        }

        function proceedToCheckout() {
            // Spring Bootã§ãƒ¬ã‚¸ãƒšãƒ¼ã‚¸ã¸ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’æƒ³å®š
            // window.location.href = '/checkout';
            displayMessage('ãƒ¬ã‚¸ã¸é€²ã‚€å‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚ï¼ˆã‚µãƒ¼ãƒãƒ¼APIã‚³ãƒ¼ãƒ«ã‚’æƒ³å®šï¼‰', 'success');
        }

        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«å®Ÿè¡Œ
        window.onload = function() {
            fetchAndDisplayCartItems();

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
            document.getElementById('modalConfirmBtn').onclick = confirmDelete;
            document.getElementById('modalCancelBtn').onclick = hideDeleteModal;

            // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹
            document.getElementById('deleteModal').addEventListener('click', function(event) {
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è‡ªä½“ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸå ´åˆã¯é–‰ã˜ãªã„
                if (event.target === this) {
                    hideDeleteModal();
                }
            });
        };
    </script>
</body>
</html>