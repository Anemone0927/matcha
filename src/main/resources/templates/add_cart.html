<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>ã‚«ãƒ¼ãƒˆã«å•†å“ã‚’è¿½åŠ  | æ¨ã—ç³»é£Ÿã¹ç‰©é€šè²©ã‚µã‚¤ãƒˆ</title>
    <style>
        body {
            background-color: #ffd9ef;
            color: #2f4f2f;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        main {
            padding: 20px;
            max-width: 900px;
            margin: 0 auto;
        }
        
        /* --- Header Style --- */
        header {
            background-color: #159450;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
            margin-bottom: 20px;
        }
        header img.home-icon {
            width: 40px;
            height: 40px;
            border-radius: 20px;
            cursor: pointer;
        }
        header h1 {
            color: white;
            font-size: 1.8em;
            margin: 0 0 0 15px;
            flex-grow: 1;
        }
        header .left {
            display: flex;
            align-items: center;
        }
        header .user-icon {
            width: 40px;
            height: 40px;
            border-radius: 20px;
            cursor: pointer;
            transition: transform 0.3s;
        }
        header .user-icon:hover {
            transform: scale(1.1);
        }

        /* --- Form & Button Style --- */
        h1 {
            text-align: center;
        }
        form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        label {
            font-weight: bold;
        }

        input[type="number"], 
        input[type="text"],
        select {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
            width: 100%;
            box-sizing: border-box; 
        }
        
        button {
            background-color: #2f4f2f;
            color: white;
            padding: 12px;
            border: none;
            border-radius: 5px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: #1f2f1f;
        }

        /* --- Card Style --- */
        .form-card {
            text-align: center; 
            color: #2f4f2f; 
            margin-top: 20px; 
            padding: 30px; 
            background-color: #fff; 
            border-radius: 10px; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.15); 
            max-width: 400px; 
            margin-left: auto; 
            margin-right: auto;
        }
        .form-card h1 {
            color: #a1835d; 
            font-size: 1.5em; 
            margin-bottom: 20px;
            margin-top: 0;
        }
        .form-card form {
            text-align: left;
        }
        .form-group {
            display: flex; 
            flex-direction: column;
            gap: 5px;
        }

    </style>
</head>
<body>
    <!-- å…±é€šãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header>
        <div class="left">
            <a th:href="@{/}">
                <img src="/images/homebotan.jpg" alt="ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã¸æˆ»ã‚‹" class="home-icon" />
            </a>
            <h1>OshiGiftBox</h1>
        </div>
        <div class="user-links">
            <a th:href="@{/users/auth_select}">
                <img src="/images/yuza.jpg" alt="ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²" class="user-icon" />
            </a>
        </div>
    </header>
    
    <main>
        <div class="form-card">
            <h1>ğŸ›’ ã‚«ãƒ¼ãƒˆã«å•†å“ã‚’è¿½åŠ </h1>
            
            <form id="addCartForm">
                
                <div class="form-group">
                    <label for="productId">å•†å“</label>
                    <select id="productId" name="productId" required>
                        <option value="">-- å•†å“ã‚’é¸ã‚“ã§ãã ã•ã„ --</option>
                        <!-- 
                          Thymeleafã® th:each ã§ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‹ã‚‰æ¸¡ã•ã‚ŒãŸ allProducts ã‚’ãƒ«ãƒ¼ãƒ— 
                          th:value ã«ã¯å•†å“IDã‚’ã€th:text ã«ã¯è¡¨ç¤ºã™ã‚‹æ–‡å­—åˆ—ã‚’æŒ‡å®š
                        -->
                        <option th:each="prod : ${allProducts}" 
                                th:value="${prod.id}" 
                                th:text="${prod.name} + ' (' + ${prod.price} + 'å††)'">
                            (å•†å“å (ä¾¡æ ¼))
                        </option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="quantity">æ•°é‡</label>
                    <input type="number" id="quantity" name="quantity" min="1" value="1" required />
                </div>

                <button type="submit">ã‚«ãƒ¼ãƒˆã«è¿½åŠ ã™ã‚‹</button>
            </form>
        </div>

<script>
    // ğŸ’¡ ä¿®æ­£: alert() ã®ä»£ã‚ã‚Šã«ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºé–¢æ•°ã‚’ä½¿ç”¨ (ä»Šå›ã¯ç°¡å˜ã®ãŸã‚alert()ã‚’ç¶šæŠ•)
    // ãŸã ã—ã€æœ¬ç•ªç’°å¢ƒã§ã¯alert()ã¯ä½¿ç”¨ã—ãªã„æ–¹ãŒè‰¯ã„
    
    document.getElementById('addCartForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const productSelect = document.getElementById('productId');
        const productId = productSelect.value;
        const quantity = document.getElementById('quantity').value;
        
        // é¸æŠã•ã‚ŒãŸ<option>ã®ãƒ†ã‚­ã‚¹ãƒˆï¼ˆå•†å“åï¼‰ã‚’å–å¾—
        const selectedProductName = productSelect.options[productSelect.selectedIndex].text;

        if (!productId) {
            alert('å•†å“ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚');
            return;
        }

        // â˜… ä¿®æ­£ç‚¹ 1: é€ä¿¡ã™ã‚‹JSONã®å½¢å¼ã‚’ã€ã‚µãƒ¼ãƒãƒ¼ãŒæœŸå¾…ã™ã‚‹ãƒ•ãƒ©ãƒƒãƒˆãªæ§‹é€ ã«æˆ»ã™
        // CartControllerã¯productIdã¨quantityã‚’ç›´æ¥Mapã‹ã‚‰èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™ã€‚
        const cartItemData = {
            productId: Number(productId), // ãƒ•ãƒ©ãƒƒãƒˆãªæ§‹é€ 
            quantity: Number(quantity)
        };

        console.log('Sending JSON:', cartItemData);
        
        fetch('/api/cart', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(cartItemData)
        })
        .then(res => {
            // â˜… ä¿®æ­£ç‚¹ 2: å¿œç­”ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã«ã‚ˆã£ã¦å‡¦ç†ã‚’åˆ†å²ã•ã›ã‚‹
            // 200 OK (æˆåŠŸ) ã®å ´åˆã®ã¿JSONã‚’ãƒ‘ãƒ¼ã‚¹ã™ã‚‹
            if (res.ok) {
                return res.json();
            }
            
            // 400 Bad Request ã‚„ 500 Internal Server Error ãªã©ã€å¤±æ•—ã®å ´åˆ
            // ã‚µãƒ¼ãƒãƒ¼ãŒå¿œç­”ãƒœãƒ‡ã‚£ã‚’ç©ºã§è¿”ã—ã¦ã„ã‚‹ãŸã‚ã€res.json()ã‚’å‘¼ã°ãšã€ç‰¹å®šã®ã‚¨ãƒ©ãƒ¼ã‚’ã‚¹ãƒ­ãƒ¼ã™ã‚‹
            if (res.status === 400) {
                // 400ã¯é€šå¸¸ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ï¼ˆä¾‹ï¼šå­˜åœ¨ã—ãªã„å•†å“IDï¼‰ã®å•é¡Œ
                throw new Error('ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒä¸æ­£ã§ã™ã€‚é¸æŠã—ãŸå•†å“IDãŒãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«å­˜åœ¨ã—ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚');
            }
            if (res.status === 500) {
                throw new Error('ã‚µãƒ¼ãƒãƒ¼å†…éƒ¨ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚è©³ç´°ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            }

            // ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼ (ä¾‹: 404 Not Found)
            throw new Error(`ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ (ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${res.status})`);
        })
        .then(data => {
            // æˆåŠŸæ™‚ã®å‡¦ç†
            alert(`ã€Œ${selectedProductName}ã€ã‚’ ${quantity} ç‚¹ã‚«ãƒ¼ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸï¼`);
            
            // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
            this.reset();
            // ã‚«ãƒ¼ãƒˆä¸€è¦§ã¸é·ç§»
            window.location.href = '/cart_list';
        })
        .catch(err => {
            // ã‚¨ãƒ©ãƒ¼æ™‚ã®å‡¦ç†
            console.error('Fetch Error:', err);
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚¨ãƒ©ãƒ¼å†…å®¹ã‚’ã‚ã‹ã‚Šã‚„ã™ãè¡¨ç¤º
            alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + err.message);
        });
    });
</script>
    </main>
</body>
</html>