<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†å“ä¸€è¦§ | OshiGiftBox</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* --- å…±é€šãƒ™ãƒ¼ã‚¹ã‚¹ã‚¿ã‚¤ãƒ« --- */
        * {
            box-sizing: border-box;
        }

        body {
            background-color: #ffd9ef; /* ãƒ”ãƒ³ã‚¯ç³»ã®èƒŒæ™¯ */
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #333;
            margin: 0;
            padding: 0;
        }

        header {
            background-color: #159450;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
            margin-bottom: 20px;
        }

        header .home-icon,
        header .user-icon {
            width: 40px;
            height: 40px;
            border-radius: 20px;
            cursor: pointer;
            transition: transform 0.3s;
        }

        header h1 {
            color: white;
            font-size: 1.8em;
            margin: 0 0 0 15px;
            flex-grow: 1;
        }

        header .left {
            display: flex;
            align-items: center;
        }

        header .user-links {
            display: flex;
            align-items: center;
        }

        main {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        /* ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ« */
        h1 {
            color: #a1835d;
            text-align: center;
            margin-bottom: 30px;
            margin-top: 0;
            font-size: 2.5em;
        }

        /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ */
        #messageBox {
            text-align: center;
            padding: 10px;
            margin: 0 auto 15px auto;
            max-width: 800px;
            border-radius: 8px;
            display: none;
            font-weight: 600;
        }

        .success {
            background-color: #e6ffe6;
            color: #4CAF50;
            border: 1px solid #4CAF50;
        }

        .error {
            background-color: #ffe6e6;
            color: #f44336;
            border: 1px solid #f44336;
        }
        
        /* ------------------------------------
           1. ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°UIã®ã‚¹ã‚¿ã‚¤ãƒ«
        ------------------------------------ */
        #filterControls {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            padding: 15px;
            background-color: #fff0f5; 
            border-radius: 10px;
            align-items: center;
            flex-wrap: wrap; 
        }
        
        #filterControls > div {
            display: flex;
            align-items: center;
            flex-grow: 1;
            min-width: 150px; /* å°ã•ã„è¦ç´ ã®æœ€å°å¹… */
        }

        #filterControls label {
            font-weight: 600;
            color: #7a6fdb;
            margin-right: 5px;
            white-space: nowrap;
        }

        #keywordInput, #categorySelect, #sortSelect {
            padding: 10px;
            border: 2px solid #ff3366;
            border-radius: 6px;
            font-size: 1em;
            flex-grow: 1; 
            min-width: 120px;
            background-color: white;
        }
        
        #keywordInput {
             min-width: 180px;
        }


        #filterButton {
            background-color: #ff3366;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 700;
            transition: background-color 0.3s;
            white-space: nowrap;
        }
        
        #filterButton:hover {
            background-color: #cc0033;
        }
        
        /* ------------------------------------
           2. å•†å“ãƒªã‚¹ãƒˆï¼ˆã‚°ãƒªãƒƒãƒ‰ï¼‰ã‚¹ã‚¿ã‚¤ãƒ«
        ------------------------------------ */
        #productList {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            padding: 0;
            list-style: none;
        }

        .product-card {
            background-color: #fff;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(122, 111, 219, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .product-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(122, 111, 219, 0.2);
        }

        .product-image-container {
            width: 100%;
            height: 200px;
            overflow: hidden;
            border-radius: 8px;
            margin-bottom: 10px;
            background-color: #f8f8f8;
        }

        .product-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .product-name {
            font-size: 1.3em;
            font-weight: 700;
            color: #7a6fdb;
            margin: 10px 0 5px 0;
            height: 2.6em; 
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .product-price {
            font-size: 1.6em;
            font-weight: 800;
            color: #ff3366;
            margin: 5px 0 15px 0;
        }

        .product-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-top: auto; 
        }

        .add-to-cart-btn {
            flex-grow: 1;
            background-color: #159450; 
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1em;
            transition: background-color 0.3s;
            margin-right: 10px;
        }

        .add-to-cart-btn:hover {
            background-color: #0d6e3e;
        }
        
        .favorite-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            font-size: 1.8em;
            color: #ccc;
            transition: color 0.3s, transform 0.1s;
        }

        .favorite-btn:hover {
            color: #ff3366;
            transform: scale(1.1);
        }

        .favorite-btn.favorited {
            color: #ff3366;
            transform: scale(1.05);
        }

        /* ------------------------------------
           3. ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ
        ------------------------------------ */
        @media screen and (max-width: 900px) {
            #filterControls {
                /* 2è¡Œæ§‹æˆã«ã™ã‚‹ */
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }
            
            #filterControls > div:nth-child(1) { /* æ¤œç´¢æ¬„ */
                grid-column: 1 / 3; /* 2åˆ—ã‚’å æœ‰ */
            }
            #filterControls > div:nth-child(2) { /* ã‚«ãƒ†ã‚´ãƒª */
                grid-column: 1 / 2;
            }
            #filterControls > div:nth-child(3) { /* ã‚½ãƒ¼ãƒˆ */
                grid-column: 2 / 3;
            }
            #filterButton {
                grid-column: 1 / 3;
            }
        }
        
        @media screen and (max-width: 650px) {
             #productList {
                grid-template-columns: 1fr; 
            }
            
            #filterControls {
                /* ç¸¦ä¸€åˆ—æ§‹æˆã«ã™ã‚‹ */
                display: flex;
                flex-direction: column;
                align-items: stretch;
            }

            #filterControls > div {
                flex-direction: row;
            }

            .product-card {
                flex-direction: row;
                text-align: left;
                align-items: flex-start;
            }
            
            .product-image-container {
                width: 100px;
                height: 100px;
                flex-shrink: 0;
                margin-right: 15px;
                margin-bottom: 0;
            }
            
            .product-details {
                flex-grow: 1;
                min-width: 0;
            }

            .product-name {
                font-size: 1.1em;
                margin-top: 0;
                height: auto;
                line-height: 1.3;
                margin-bottom: 5px;
            }

            .product-price {
                font-size: 1.4em;
                margin-bottom: 10px;
            }

            .product-actions {
                flex-direction: row;
                margin-top: 5px;
                align-items: center;
            }
            
            .add-to-cart-btn {
                padding: 8px 12px;
                font-size: 0.9em;
            }
        }

    </style>
</head>

<body>
    <header>
        <div class="left">
            <a th:href="@{/}" href="/">
                <img src="/images/homebotan.jpg" alt="ãƒ›ãƒ¼ãƒ " class="home-icon" />
            </a>
            <h1>OshiGiftBox</h1>
        </div>
        <div class="user-links">
            <a th:href="@{/cart}">
                <i class="fas fa-shopping-cart" style="color: white; font-size: 2em; margin-right: 15px;"></i>
            </a>
            <a th:href="@{/users/auth_select}">
                <img src="/images/yuza.jpg" alt="ãƒ¦ãƒ¼ã‚¶ãƒ¼" class="user-icon" />
            </a>
        </div>
    </header>

    <main>
        <h1>ğŸ å•†å“ä¸€è¦§</h1>
        
        <div id="messageBox"></div>

        <div id="filterControls">
            <div>
                <label for="keywordInput"><i class="fas fa-search"></i> æ¤œç´¢</label>
                <input type="text" id="keywordInput" placeholder="å•†å“åã‚’å…¥åŠ›">
            </div>
            
            <div>
                <label for="categorySelect"><i class="fas fa-tags"></i> ã‚«ãƒ†ã‚´ãƒª</label>
                <select id="categorySelect">
                    <option value="">å…¨ã¦ã®ã‚«ãƒ†ã‚´ãƒª</option>
                    <option value="PENLIGHT">ãƒšãƒ³ãƒ©ã‚¤ãƒˆ</option>
                    <option value="ACRYLIC_STAND">ã‚¢ã‚¯ãƒªãƒ«ã‚¹ã‚¿ãƒ³ãƒ‰</option>
                    <option value="WEAR">Tã‚·ãƒ£ãƒ„ãƒ»ã‚¦ã‚§ã‚¢</option>
                    <option value="GOODS">ãã®ä»–ã‚°ãƒƒã‚º</option>
                </select>
            </div>
            
            <div>
                <label for="sortSelect"><i class="fas fa-sort-amount-down"></i> ã‚½ãƒ¼ãƒˆ</label>
                <select id="sortSelect">
                    <option value="newest">æ–°ç€é †</option>
                    <option value="price_asc">ä¾¡æ ¼ãŒå®‰ã„é †</option>
                    <option value="price_desc">ä¾¡æ ¼ãŒé«˜ã„é †</option>
                </select>
            </div>
            
            <button id="filterButton" onclick="applyFilters()">
                <i class="fas fa-filter"></i> çµã‚Šè¾¼ã¿ã‚’é©ç”¨
            </button>
        </div>
        <ul id="productList">
            <p style="text-align: center; color: #7a6fdb; font-weight: 600;">å•†å“æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
        </ul>
    </main>

    <script>
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã®çŠ¶æ…‹ã‚’ç®¡ç†ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
        let currentFilters = {
            keyword: '',
            category: '',
            sortKey: 'newest' // åˆæœŸå€¤ã¯æ–°ç€é †
        };

        // ----------------------------------------------------
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºé–¢æ•° 
        // ----------------------------------------------------
        function displayMessage(message, type = 'success') {
            const box = document.getElementById('messageBox');
            box.textContent = message;
            box.className = '';
            box.classList.add(type);
            box.style.display = 'block';
            setTimeout(() => {
                box.style.display = 'none';
            }, 3000);
        }

        // ----------------------------------------------------
        // ã‚«ãƒ¼ãƒˆã«è¿½åŠ ã™ã‚‹å‡¦ç† (ã‚µãƒ¼ãƒãƒ¼APIã‚³ãƒ¼ãƒ«ã‚’æƒ³å®š)
        // ----------------------------------------------------
        async function addToCart(id, name) {
            try {
                // APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: /api/cart
                const response = await fetch(`/api/cart`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        productId: id,
                        quantity: 1
                    })
                });

                if (response.ok) {
                    displayMessage(`ã€Œ${name}ã€ã‚’ã‚«ãƒ¼ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸï¼`, 'success');
                } else if (response.status === 400) {
                    const errorText = await response.text();
                    displayMessage(`ã‚«ãƒ¼ãƒˆè¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ${errorText}`, 'error');
                } else {
                    const errorText = await response.text();
                    throw new Error(`[${response.status}] ã‚«ãƒ¼ãƒˆè¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ${errorText}`);
                }
            } catch (err) {
                console.error('ã‚«ãƒ¼ãƒˆè¿½åŠ ã‚¨ãƒ©ãƒ¼:', err);
                displayMessage(`ã‚«ãƒ¼ãƒˆè¿½åŠ å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚`, 'error');
            }
        }
        
        // ----------------------------------------------------
        // ãŠæ°—ã«å…¥ã‚ŠçŠ¶æ…‹ã‚’ãƒˆã‚°ãƒ«ã™ã‚‹é–¢æ•° (ã‚µãƒ¼ãƒãƒ¼APIã‚³ãƒ¼ãƒ«ã‚’æƒ³å®š)
        // ----------------------------------------------------
        async function toggleFavorite(id, buttonElement) {
            const isFavorited = buttonElement.classList.contains('favorited');
            const method = isFavorited ? 'DELETE' : 'POST';
            const actionText = isFavorited ? 'ãŠæ°—ã«å…¥ã‚Šè§£é™¤' : 'ãŠæ°—ã«å…¥ã‚Šç™»éŒ²';

            try {
                // APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: /api/products/{id}/favorite
                const response = await fetch(`/api/products/${id}/favorite`, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });

                if (response.ok) {
                    // UIã®æ›´æ–°
                    buttonElement.classList.toggle('favorited');
                    const icon = buttonElement.querySelector('i');
                    if (icon) {
                        icon.classList.toggle('far', isFavorited);
                        icon.classList.toggle('fas', !isFavorited);
                    }
                    displayMessage(`${actionText}ãŒå®Œäº†ã—ã¾ã—ãŸã€‚`, 'success');
                } else if (response.status === 401) {
                    displayMessage('ãŠæ°—ã«å…¥ã‚Šæ©Ÿèƒ½ã¯ãƒ­ã‚°ã‚¤ãƒ³å¾Œã«ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™ã€‚', 'error');
                } else {
                    const errorText = await response.text();
                    throw new Error(`[${response.status}] ${actionText}ã«å¤±æ•—ã—ã¾ã—ãŸ: ${errorText}`);
                }
            } catch (err) {
                console.error('ãŠæ°—ã«å…¥ã‚Šå‡¦ç†ã‚¨ãƒ©ãƒ¼:', err);
                displayMessage(`${actionText}å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚`, 'error');
            }
        }
        
        // ----------------------------------------------------
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’é©ç”¨ã™ã‚‹é–¢æ•°
        // ----------------------------------------------------
        function applyFilters() {
            const keyword = document.getElementById('keywordInput').value.trim();
            const category = document.getElementById('categorySelect').value;
            const sortKey = document.getElementById('sortSelect').value; 
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã®çŠ¶æ…‹ã‚’æ›´æ–°
            currentFilters.keyword = keyword;
            currentFilters.category = category;
            currentFilters.sortKey = sortKey; 

            // å•†å“ã®å†å–å¾—ã¨è¡¨ç¤º
            fetchAndDisplayProducts();
        }


        // ----------------------------------------------------
        // å•†å“ãƒªã‚¹ãƒˆã‚’å–å¾—ã—è¡¨ç¤ºã™ã‚‹å‡¦ç† (ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å¯¾å¿œ)
        // ----------------------------------------------------
        async function fetchAndDisplayProducts() {
            const list = document.getElementById('productList');
            list.innerHTML = '<p style="text-align: center; color: #7a6fdb; font-weight: 600; padding: 15px;">å•†å“æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>';
            
            // ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ä½œæˆ
            const params = new URLSearchParams();
            if (currentFilters.keyword) {
                params.append('keyword', currentFilters.keyword);
            }
            if (currentFilters.category) {
                params.append('category', currentFilters.category);
            }
            if (currentFilters.sortKey) {
                params.append('sort', currentFilters.sortKey); 
            }
            
            const queryString = params.toString() ? `?${params.toString()}` : '';
            const url = `/api/products${queryString}`;
            
            console.log(`Fetching products from: ${url}`); // ãƒ‡ãƒãƒƒã‚°ç”¨

            let data = [];
            
            try {
                // APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: /api/products?keyword=...&category=...&sort=...
                const response = await fetch(url);
                if (!response.ok) {
                    const errorDetail = await response.text();
                    throw new Error(`å•†å“æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${response.status} è©³ç´°: ${errorDetail}`);
                }

                data = await response.json();

            } catch (err) {
                console.error('ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', err);
                displayMessage(`å•†å“ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ã€/api/productsã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒæ­£ã—ãå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚`, 'error');
                list.innerHTML = '<p style="text-align: center; color: #f44336; font-weight: 600; padding: 15px;">å•†å“ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>';
                return;
            }

            list.innerHTML = ''; // ãƒ­ãƒ¼ãƒ‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢

            if (data.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #7a6fdb; font-weight: 600; padding: 15px;">è©²å½“ã™ã‚‹å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>';
                return;
            }

            data.forEach(item => {
                const li = document.createElement('li');
                li.classList.add('product-card');
                li.dataset.productId = item.id; 

                // ç”»åƒURLãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã®ä»£æ›¿ç”»åƒãƒ­ã‚¸ãƒƒã‚¯
                const imageSrc = item.imagePath && item.imagePath !== 'undefined' ?
                    item.imagePath :
                    `https://placehold.co/300x200/cccccc/ffffff?text=${encodeURIComponent(item.name).substring(0, 10)}`;

                const favoriteClass = item.isFavorited ? 'favorited' : '';
                const iconClass = item.isFavorited ? 'fas' : 'far'; 

                li.innerHTML = `
                    <div class="product-image-container">
                        <img src="${imageSrc}"
                            alt="${item.name}ã®ç”»åƒ"
                            onerror="this.onerror=null;this.src='https://placehold.co/300x200/cccccc/ffffff?text=${encodeURIComponent('No Img')}';">
                    </div>
                    <div class="product-details">
                        <div class="product-name">${item.name}</div>
                        <div class="product-price">Â¥${item.price.toLocaleString()}</div>
                        
                        <div class="product-actions">
                            <button type="button"
                                class="add-to-cart-btn"
                                onclick="addToCart(${item.id}, '${item.name.replace(/'/g, "\\'")}')">
                                <i class="fas fa-cart-plus"></i> ã‚«ãƒ¼ãƒˆã«è¿½åŠ 
                            </button>
                            <button type="button"
                                class="favorite-btn ${favoriteClass}"
                                onclick="toggleFavorite(${item.id}, this)"
                                title="ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ /è§£é™¤">
                                <i class="${iconClass} fa-heart"></i>
                            </button>
                        </div>
                    </div>
                `;
                list.appendChild(li);
            });
        }

        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«å®Ÿè¡Œ
        window.onload = function() {
            // Enterã‚­ãƒ¼ã§æ¤œç´¢ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®ãƒªã‚¹ãƒŠãƒ¼
            document.getElementById('keywordInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    applyFilters();
                }
            });

            // ã‚«ãƒ†ã‚´ãƒªé¸æŠãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰è‡ªå‹•ã§æ¤œç´¢ã‚’å®Ÿè¡Œ
            document.getElementById('categorySelect').addEventListener('change', applyFilters);
            
            // ã‚½ãƒ¼ãƒˆé¸æŠãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰è‡ªå‹•ã§æ¤œç´¢ã‚’å®Ÿè¡Œ
            document.getElementById('sortSelect').addEventListener('change', applyFilters);

            // åˆæœŸè¡¨ç¤º
            fetchAndDisplayProducts();
        };
    </script>
</body>
</html>