<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†å“ä¸€è¦§ | OshiGiftBox</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* --- å…±é€šãƒ™ãƒ¼ã‚¹ã‚¹ã‚¿ã‚¤ãƒ« --- */
        * {
            box-sizing: border-box;
        }

        body {
            background-color: #ffd9ef;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #333;
            margin: 0;
            padding: 0;
        }

        header {
            background-color: #159450;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
            margin-bottom: 20px;
        }

        header .home-icon,
        header .user-icon {
            width: 40px;
            height: 40px;
            border-radius: 20px;
            cursor: pointer;
            transition: transform 0.3s;
        }

        header h1 {
            color: white;
            font-size: 1.8em;
            margin: 0 0 0 15px;
            flex-grow: 1;
        }

        header .left {
            display: flex;
            align-items: center;
        }

        header .user-links {
            display: flex;
            align-items: center;
        }

        main {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: #a1835d;
            text-align: center;
            margin-bottom: 30px;
            margin-top: 0;
            font-size: 2.5em;
        }

        /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ */
        #messageBox {
            text-align: center;
            padding: 10px;
            margin: 0 auto 15px auto;
            max-width: 800px;
            border-radius: 8px;
            display: none;
            font-weight: 600;
            z-index: 100;
        }
        .success { background-color: #e6ffe6; color: #4CAF50; border: 1px solid #4CAF50; }
        .error { background-color: #ffe6e6; color: #f44336; border: 1px solid #f44336; }

        /* --- ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°UI --- */
        #filterControls {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            padding: 15px;
            background-color: #fff0f5; 
            border-radius: 10px;
            align-items: center;
            flex-wrap: wrap; 
        }
        #filterControls > div { display: flex; align-items: center; flex-grow: 1; }
        #filterControls label { font-weight: 600; color: #7a6fdb; margin-right: 5px; white-space: nowrap; }
        #keywordInput, #categorySelect, #sortSelect {
            padding: 10px; border: 2px solid #ff3366; border-radius: 6px; font-size: 1em; flex-grow: 1; min-width: 120px;
        }
        #filterButton {
            background-color: #ff3366; color: white; padding: 10px 15px; border: none; border-radius: 6px;
            cursor: pointer; font-weight: 700; white-space: nowrap; transition: background-color 0.3s;
        }
        #filterButton:hover { background-color: #cc0033; }

        /* --- å•†å“ãƒªã‚¹ãƒˆï¼ˆã‚°ãƒªãƒƒãƒ‰ï¼‰ --- */
        #productList {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            padding: 0;
            list-style: none;
        }

        .product-card {
            background-color: #fff;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(122, 111, 219, 0.1);
            display: flex;
            flex-direction: column;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .product-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(122, 111, 219, 0.2);
        }

        .product-image-container {
            width: 100%; height: 200px; overflow: hidden; border-radius: 8px;
            background-color: #f8f8f8; margin-bottom: 12px;
        }
        .product-image-container img { width: 100%; height: 100%; object-fit: cover; }

        /* --- å•†å“åã¨ãŠæ°—ã«å…¥ã‚Šãƒœã‚¿ãƒ³ã®é…ç½® --- */
        .product-header {
            display: flex;
            align-items: center; /* ä¸Šä¸‹ä¸­å¤®æƒãˆ */
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 8px;
        }

        .product-name {
            font-size: 1.1em;
            font-weight: 700;
            color: #7a6fdb;
            margin: 0;
            flex-grow: 1;
            /* 2è¡Œã¾ã§è¡¨ç¤ºã—ã€è¶…ãˆãŸã‚‰... */
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-height: 1.3;
        }

        .favorite-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #ccc;
            font-size: 1.4em; /* å°‘ã—å°ã•ã‚ã«èª¿æ•´ */
            padding: 4px;
            transition: color 0.3s, transform 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .favorite-btn:hover { transform: scale(1.15); }
        .favorite-btn.favorited { color: #ff3366; }

        .product-price {
            font-size: 1.4em;
            font-weight: 800;
            color: #ff3366;
            margin-bottom: 15px;
        }

        /* --- ç®¡ç†ç”¨ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ --- */
        .admin-controls {
            display: flex;
            gap: 8px;
            border-top: 1px solid #f0f0f0;
            padding-top: 12px;
            margin-top: auto; /* ã‚«ãƒ¼ãƒ‰ã®ä¸‹éƒ¨ã«å›ºå®š */
        }

        .btn {
            border: none; border-radius: 8px; cursor: pointer; font-weight: 600;
            padding: 10px; transition: background-color 0.3s, transform 0.1s;
            text-decoration: none; text-align: center; font-size: 0.9em;
        }

        .edit-btn { background-color: #7a6fdb; color: white; flex: 1; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .edit-btn:hover { background-color: #5d52b4; }

        .delete-btn { background-color: #ff7f7f; color: white; flex: 1; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .delete-btn:hover { background-color: #e55e5e; }

        /* --- ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5); display: none;
            justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background-color: #fff; padding: 30px; border-radius: 15px;
            max-width: 400px; width: 90%; text-align: center;
        }
        .modal-actions { display: flex; gap: 15px; margin-top: 20px; }
        .modal-actions button { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; }
        .confirm-btn { background-color: #ff7f7f; color: white; }
        .cancel-btn { background-color: #f0f0f0; color: #555; }

        /* --- ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– --- */
        @media screen and (max-width: 600px) {
            .product-card { flex-direction: row; padding: 10px; flex-wrap: wrap; }
            .product-image-container { width: 90px; height: 90px; margin-right: 12px; margin-bottom: 0; }
            .product-details-container { flex: 1; min-width: 150px; display: flex; flex-direction: column; }
            .product-header { margin-bottom: 4px; }
            .product-name { font-size: 0.95em; -webkit-line-clamp: 1; }
            .product-price { font-size: 1.1em; margin-bottom: 5px; }
            .admin-controls { width: 100%; margin-top: 10px; padding-top: 8px; }
            .btn { padding: 8px; font-size: 0.8em; }
        }
    </style>
</head>

<body>
    <header>
        <div class="left">
            <a th:href="@{/}" href="/">
                <img src="/images/homebotan.jpg" alt="ãƒ›ãƒ¼ãƒ " class="home-icon" />
            </a>
            <h1>OshiGiftBox</h1>
        </div>
        <div class="user-links">
            <a th:href="@{/users/auth_select}">
                <img src="/images/yuza.jpg" alt="ãƒ¦ãƒ¼ã‚¶ãƒ¼" class="user-icon" />
            </a>
        </div>
    </header>

    <main>
        <h1>ğŸ å•†å“ä¸€è¦§</h1>
        <div id="messageBox"></div>

        <section id="filterControls">
            <div>
                <label for="keywordInput"><i class="fas fa-search"></i> æ¤œç´¢</label>
                <input type="text" id="keywordInput" placeholder="å•†å“åã‚’å…¥åŠ›">
            </div>
            <div>
                <label for="categorySelect"><i class="fas fa-tags"></i> ã‚«ãƒ†ã‚´ãƒª</label>
                <select id="categorySelect">
                    <option value="">å…¨ã¦ã®ã‚«ãƒ†ã‚´ãƒª</option>
                    <option value="PENLIGHT">ãƒšãƒ³ãƒ©ã‚¤ãƒˆ</option>
                    <option value="ACRYLIC_STAND">ã‚¢ã‚¯ãƒªãƒ«ã‚¹ã‚¿ãƒ³ãƒ‰</option>
                    <option value="WEAR">Tã‚·ãƒ£ãƒ„ãƒ»ã‚¦ã‚§ã‚¢</option>
                    <option value="SWEETS">ãŠè“å­</option>
                    <option value="GOODS">ãã®ä»–ã‚°ãƒƒã‚º</option>
                </select>
            </div>
            <div>
                <label for="sortSelect"><i class="fas fa-sort-amount-down"></i> ã‚½ãƒ¼ãƒˆ</label>
                <select id="sortSelect">
                    <option value="newest">æ–°ç€é †</option>
                    <option value="price_asc">ä¾¡æ ¼ãŒå®‰ã„é †</option>
                    <option value="price_desc">ä¾¡æ ¼ãŒé«˜ã„é †</option>
                </select>
            </div>
            <button id="filterButton" onclick="applyFilters()">
                <i class="fas fa-filter"></i> é©ç”¨
            </button>
        </section>

        <ul id="productList">
            <p style="text-align: center; color: #7a6fdb; font-weight: 600;">å•†å“æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
        </ul>
    </main>

    <div id="deleteModal" class="modal-overlay">
        <div class="modal-content">
            <p id="modalMessage">ã“ã®å•†å“ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</p>
            <div class="modal-actions">
                <button id="modalConfirmBtn" class="confirm-btn">å‰Šé™¤ã™ã‚‹</button>
                <button id="modalCancelBtn" class="cancel-btn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>

    <script>
        let currentFilters = { keyword: '', category: '', sortKey: 'newest' };
        let itemToDeleteId = null;

        const FAVORITES_STORAGE_KEY = 'oshiGiftBox_favorites';
        function getFavorites() {
            const favoritesJson = localStorage.getItem(FAVORITES_STORAGE_KEY);
            return favoritesJson ? new Set(JSON.parse(favoritesJson)) : new Set();
        }
        function saveFavorites(favoritesSet) {
            localStorage.setItem(FAVORITES_STORAGE_KEY, JSON.stringify(Array.from(favoritesSet)));
        }

        function displayMessage(message, type = 'success') {
            const box = document.getElementById('messageBox');
            box.textContent = message;
            box.className = type;
            box.style.display = 'block';
            setTimeout(() => { box.style.display = 'none'; }, 3000);
        }

        function applyFilters() {
            currentFilters.keyword = document.getElementById('keywordInput').value.trim();
            currentFilters.category = document.getElementById('categorySelect').value;
            currentFilters.sortKey = document.getElementById('sortSelect').value;
            fetchAndDisplayProducts();
        }

        // å•†å“ä¸€è¦§å–å¾—
        async function fetchAndDisplayProducts() {
            const list = document.getElementById('productList');
            list.innerHTML = '<p style="text-align: center;">èª­ã¿è¾¼ã¿ä¸­...</p>';

            const params = new URLSearchParams();
            if (currentFilters.keyword) params.append('keyword', currentFilters.keyword);
            if (currentFilters.category) params.append('category', currentFilters.category);
            params.append('sort', currentFilters.sortKey);

            try {
                // ãƒ‡ãƒ¢ç”¨ã«fetchã®ä»£ã‚ã‚Šã«ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã†å ´åˆã¯ã“ã“ã‚’èª¿æ•´
                const response = await fetch(`/api/products?${params.toString()}`);
                const data = await response.json();
                const favorites = getFavorites();

                list.innerHTML = '';
                if (data.length === 0) {
                    list.innerHTML = '<p style="text-align: center;">è©²å½“ã™ã‚‹å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>';
                    return;
                }

                data.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'product-card';
                    
                    const isItemFavorited = item.isFavorited || favorites.has(item.id);
                    const imageSrc = item.imagePath && item.imagePath !== 'undefined' ? item.imagePath : `https://placehold.co/300x200?text=No+Image`;

                    li.innerHTML = `
                        <div class="product-image-container">
                            <img src="${imageSrc}" alt="${item.name}" onerror="this.src='https://placehold.co/300x200?text=No+Image'">
                        </div>
                        <div class="product-details-container">
                            <div class="product-header">
                                <h3 class="product-name">${item.name}</h3>
                                <button class="favorite-btn ${isItemFavorited ? 'favorited' : ''}" onclick="toggleFavorite(${item.id}, this)">
                                    <i class="${isItemFavorited ? 'fas' : 'far'} fa-heart"></i>
                                </button>
                            </div>
                            <div class="product-price">Â¥${item.price.toLocaleString()}</div>
                            
                            <div class="admin-controls">
                                <a href="/products/edit/${item.id}" class="btn edit-btn">
                                    <i class="fas fa-edit"></i> å¤‰æ›´
                                </a>
                                <button class="btn delete-btn" onclick="openDeleteModal(${item.id}, '${item.name}')">
                                    <i class="fas fa-trash-alt"></i> å‰Šé™¤
                                </button>
                            </div>
                        </div>
                    `;
                    list.appendChild(li);
                });
            } catch (err) {
                list.innerHTML = '<p style="text-align: center; color: red;">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>';
            }
        }

        // ãŠæ°—ã«å…¥ã‚Š
        async function toggleFavorite(id, btn) {
            // ã‚¤ãƒ™ãƒ³ãƒˆä¼æ’­ã‚’é˜²ãï¼ˆã‚«ãƒ¼ãƒ‰å…¨ä½“ã«ãƒªãƒ³ã‚¯ãŒã‚ã‚‹å ´åˆãªã©ï¼‰
            event.stopPropagation();
            
            const isFav = btn.classList.contains('favorited');
            try {
                const response = await fetch(`/favorite/add/${id}`, { method: 'POST' });
                if (response.ok) {
                    btn.classList.toggle('favorited');
                    const icon = btn.querySelector('i');
                    icon.className = btn.classList.contains('favorited') ? 'fas fa-heart' : 'far fa-heart';
                    
                    const favs = getFavorites();
                    isFav ? favs.delete(id) : favs.add(id);
                    saveFavorites(favs);
                }
            } catch (err) { displayMessage('ãŠæ°—ã«å…¥ã‚Šå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error'); }
        }

        // å‰Šé™¤ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡
        function openDeleteModal(id, name) {
            itemToDeleteId = id;
            document.getElementById('modalMessage').textContent = `ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`;
            document.getElementById('deleteModal').style.display = 'flex';
        }

        document.getElementById('modalCancelBtn').onclick = () => {
            document.getElementById('deleteModal').style.display = 'none';
        };

        document.getElementById('modalConfirmBtn').onclick = async () => {
            if (!itemToDeleteId) return;
            try {
                const response = await fetch(`/api/products/${itemToDeleteId}`, { method: 'DELETE' });
                if (response.ok) {
                    displayMessage('å•†å“ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                    fetchAndDisplayProducts();
                } else {
                    displayMessage('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            } catch (err) { displayMessage('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error'); }
            document.getElementById('deleteModal').style.display = 'none';
        };

        window.onload = () => {
            fetchAndDisplayProducts();
            document.getElementById('keywordInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') applyFilters();
            });
        };
    </script>
</body>
</html>