<!DOCTYPE html>

<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- ğŸ’¡ ã‚«ãƒ¼ãƒˆä¸€è¦§ã«å¤‰æ›´ -->

    <title>ã‚«ãƒ¼ãƒˆä¸€è¦§ | OshiGiftBox</title>

    <!-- Font Awesome (ãƒãƒ¼ãƒˆ/ã‚«ãƒ¼ãƒˆã‚¢ã‚¤ã‚³ãƒ³ã®ãŸã‚ã«ä½¿ç”¨) -->

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">



<style>

/* --- å…¨ã¦ã®è¦ç´ ã« box-sizing: border-box ã‚’é©ç”¨ã—ã¦ã€å¹…ã®è¨ˆç®—ã‚’æ­£ç¢ºã«ã—ã¾ã™ --- */

* {

    box-sizing: border-box; 

}

/* ------------------------------------

    1. å…±é€šãƒ™ãƒ¼ã‚¹ã‚¹ã‚¿ã‚¤ãƒ«

------------------------------------ */

    body {

        background-color: #ffd9ef;

        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;

        color: #333;

        margin: 0;

        padding: 0;

    }



    main {

        padding: 20px;

        max-width: 900px; 

        margin: 0 auto;

    }



    /* --- Header Style --- */

    header {

        background-color: #159450;

        padding: 10px 20px;

        display: flex;

        align-items: center;

        justify-content: space-between;

        box-shadow: 0 2px 5px rgba(0,0,0,0.15);

        margin-bottom: 20px;

    }

    header .home-icon,

    header .user-icon {

        width: 40px;

        height: 40px;

        border-radius: 20px;

        cursor: pointer;

        transition: transform 0.3s;

    }

    header .home-icon:hover,

    header .user-icon:hover {

        transform: scale(1.1);

    }

    header h1 {

        color: white;

        font-size: 1.8em;

        margin: 0 0 0 15px;

        flex-grow: 1;

    }

    header .left {

        display: flex;

        align-items: center;

    }

    header .user-links {

        display: flex;

        align-items: center;

    }

    

    /* ------------------------------------

        2. ãƒšãƒ¼ã‚¸å›ºæœ‰ã®ã‚¹ã‚¿ã‚¤ãƒ« (ã‚«ãƒ¼ãƒˆä¸€è¦§)

    ------------------------------------ */

    /* ğŸ’¡ H1ã‚’ã‚«ãƒ¼ãƒˆä¸€è¦§ã«å¤‰æ›´ */

    h1 {

        color: #a1835d; 

        text-align: center;

        margin-bottom: 30px;

        margin-top: 0;

    }



    /* ğŸ’¡ ç™½ã„ãƒœãƒƒã‚¯ã‚¹ã®ã‚¹ã‚¿ã‚¤ãƒ« (ãƒªã‚¹ãƒˆå…¨ä½“ã‚’å›²ã‚€) */

    .list-card {

        background-color: #fff;

        width: 100%; 

        max-width: 750px;

        margin: 0 auto;

        padding: 30px;

        border-radius: 12px;

        box-shadow: 0 4px 8px rgba(122, 111, 219, 0.2);

        text-align: center;

    }



    /* ğŸ’¡ H2ã‚’ã‚«ãƒ¼ãƒˆãƒªã‚¹ãƒˆã«å¤‰æ›´ */

    .list-card h2 {

        color: #7a6fdb;

        text-align: center;

        font-size: 1.5em;

        margin-top: 0;

        margin-bottom: 20px;

    }



    /* ğŸ’¡ ãƒ¬ã‚¸ã«é€²ã‚€ãƒœã‚¿ãƒ³ (ä»¥å‰ã®å•†å“ç™»éŒ²ãƒœã‚¿ãƒ³) */

    .checkout-btn {

        display: inline-block;

        background-color: #7a6fdb;

        color: white;

        padding: 12px 25px;

        margin-bottom: 20px;

        border-radius: 10px;

        text-decoration: none;

        font-weight: 700;

        font-size: 1.1em;

        transition: background-color 0.3s;

        border: none;

        cursor: pointer;

    }

    .checkout-btn:hover {

        background-color: #5d52b4;

    }



    /* å•†å“ãƒªã‚¹ãƒˆ (ul) ã®ã‚¹ã‚¿ã‚¤ãƒ« */

    #productList {

        list-style: none;

        padding: 0;

        margin: 0;

        text-align: left;

    }



    /* å€‹åˆ¥å•†å“ã‚¢ã‚¤ãƒ†ãƒ  (li) ã®ã‚¹ã‚¿ã‚¤ãƒ« */

    #productList li {

        display: flex;

        justify-content: space-between;

        align-items: center;

        padding: 15px 0;

        border-bottom: 1px solid #eee;

        /* flex-wrap: wrap; /* ã‚¹ãƒãƒ›å¯¾å¿œã®ãŸã‚ */

    }

    #productList li:last-child {

        border-bottom: none;

    }



    .product-info {

        display: flex;

        align-items: center;

        flex-grow: 1;

        gap: 15px; /* å•†å“åã¨ç”»åƒã®é–“ã®éš™é–“ */

    }



    .product-info strong {

        font-size: 1.1em;

        min-width: 150px;

        /* margin-right: 15px; */

    }

    .product-price-subtotal {

        min-width: 120px;

        text-align: right;

    }



    /* ç”»åƒã‚³ãƒ³ãƒ†ãƒŠã®ã‚¹ã‚¿ã‚¤ãƒ« */

    .product-image-container {

        width: 60px; /* ã‚«ãƒ¼ãƒˆã§ã¯å°‘ã—å°ã•ã‚ã« */

        height: 60px;

        overflow: hidden;

        border-radius: 8px;

        box-shadow: 0 2px 4px rgba(0,0,0,0.1);

        flex-shrink: 0;

    }

    .product-image-container img {

        width: 100%;

        height: 100%;

        object-fit: cover;

        display: block;

    }

    

    /* ğŸ’¡ æ•°é‡ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */

    .quantity-controls {

        display: flex;

        align-items: center;

        gap: 5px;

        min-width: 120px;

        justify-content: center;

    }

    .quantity-controls button {

        background-color: #f0f0f0;

        border: 1px solid #ddd;

        border-radius: 5px;

        width: 30px;

        height: 30px;

        font-size: 1.1em;

        cursor: pointer;

        transition: background-color 0.2s;

    }

    .quantity-controls button:hover {

        background-color: #e0e0e0;

    }

    .quantity-input {

        width: 40px;

        text-align: center;

        border: 1px solid #ccc;

        border-radius: 5px;

        padding: 5px 2px;

        font-size: 1em;

    }





    /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ï¼ˆå‰Šé™¤ãƒ»ãŠæ°—ã«å…¥ã‚Šï¼‰ã®ã‚³ãƒ³ãƒ†ãƒŠ */

    .item-controls {

        display: flex;

        align-items: center;

        gap: 15px;

        min-width: 180px; /* æ•°é‡ã¨å‰Šé™¤ãƒœã‚¿ãƒ³ã®åˆè¨ˆå¹… */

        justify-content: flex-end;

    }



    .favorite-btn {

        background: none;

        border: none;

        cursor: pointer;

        padding: 5px;

        font-size: 1.5em;

        color: #ccc; 

        transition: color 0.3s, transform 0.1s;

        min-width: 30px;

        flex-shrink: 0; /* ç¸®å°ã•ã›ãªã„ */

    }

    .favorite-btn:hover {

        color: #ff3366;

        transform: scale(1.1);

    }

    .favorite-btn.favorited {

        color: #ff3366; 

        transform: scale(1.05);

    }



    .delete-btn {

        background-color: #ff7f7f;

        color: white;

        border: none;

        padding: 6px 12px;

        border-radius: 8px;

        cursor: pointer;

        font-size: 0.9em;

        transition: background-color 0.3s;

        font-weight: 600;

        white-space: nowrap; 

        flex-shrink: 0;

    }

    .delete-btn:hover {

        background-color: #e55e5e;

    }



    /* ğŸ’¡ åˆè¨ˆé‡‘é¡è¡¨ç¤ºã‚¨ãƒªã‚¢ */

    #totalPriceContainer {

        border-top: 3px solid #7a6fdb;

        padding-top: 20px;

        margin-top: 20px;

        text-align: right;

    }

    #totalPriceContainer p {

        margin: 5px 0;

        font-size: 1.2em;

        font-weight: 700;

    }

    #totalPriceContainer #grandTotal {

        font-size: 1.8em;

        color: #ff3366;

    }





    /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ */

    #messageBox {

        text-align: center;

        padding: 10px;

        margin-bottom: 15px;

        border-radius: 8px;

        display: none; 

        font-weight: 600;

    }

    .success {

        background-color: #e6ffe6;

        color: #4CAF50;

        border: 1px solid #4CAF50;

    }

    .error {

        background-color: #ffe6e6;

        color: #f44336;

        border: 1px solid #f44336;

    }



    /* ------------------------------------

        3. ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ

    ------------------------------------ */

    @media screen and (max-width: 768px) {

        .product-info strong {

            min-width: 100px;

        }

        .product-price-subtotal {

            min-width: 80px;

        }

        .quantity-controls {

             min-width: 100px;

        }

        .item-controls {

            min-width: 150px;

            gap: 5px;

        }

    }



    @media screen and (max-width: 600px) {

        .list-card {

            padding: 15px;

        }

        /* 1è¡Œã ã£ãŸè¦ç´ ã‚’è¤‡æ•°è¡Œã«æŠ˜ã‚Šè¿”ã™ */

        #productList li {

            flex-direction: row;

            flex-wrap: wrap; /* è¦ç´ ã‚’æŠ˜ã‚Šè¿”ã™ */

            gap: 10px;

        }



        .product-info {

            width: 100%;

            justify-content: flex-start;

            margin-bottom: 10px;

            gap: 10px;

        }

        .product-info strong {

            min-width: auto;

            flex-grow: 1; /* åå‰ã‚’å„ªå…ˆã—ã¦åºƒã’ã‚‹ */

        }

        .product-image-container {

            order: -1; /* ç”»åƒã‚’ä¸€ç•ªå·¦ã«ç§»å‹• */

            margin-right: 5px;

        }



        /* æ•°é‡ã¨å°è¨ˆã¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ¨ªä¸¦ã³ã« */

        .quantity-controls, .product-price-subtotal, .item-controls {

            /* 3åˆ—ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ä½œæˆ */

            width: 33.33%;

            margin: 0;

            padding: 0;

            display: flex;

            justify-content: center; /* ä¸­å¤®å¯„ã› */

            align-items: center;

        }

        .product-price-subtotal {

            text-align: center;

        }

        .item-controls {

            justify-content: flex-end; /* å³å¯„ã› */

            gap: 5px;

        }

        .delete-btn {

            padding: 6px 8px;

        }

        

    }



    /* ------------------------------------

        4. Custom Modal Style

    ------------------------------------ */

    .modal-overlay {

        position: fixed;

        top: 0;

        left: 0;

        width: 100%;

        height: 100%;

        background-color: rgba(0, 0, 0, 0.5);

        display: none; 

        justify-content: center;

        align-items: center;

        z-index: 1000;

        padding: 20px;

    }

    .modal-content {

        background-color: #fff;

        padding: 30px;

        border-radius: 15px;

        box-shadow: 0 5px 25px rgba(122, 111, 219, 0.4);

        max-width: 400px;

        width: 100%;

        text-align: center;

    }

    #modalMessage {

        font-size: 1.1em;

        font-weight: 600;

        margin-bottom: 25px;

        color: #7a6fdb; 

    }

    .modal-actions {

        display: flex;

        justify-content: space-around;

        gap: 15px;

    }

    .modal-actions button {

        flex-grow: 1;

        padding: 12px 15px;

        border: none;

        border-radius: 8px;

        font-weight: 700;

        cursor: pointer;

        transition: background-color 0.3s, transform 0.1s;

        font-size: 1em;

        box-shadow: 0 2px 4px rgba(0,0,0,0.1);

    }

    .confirm-btn {

        background-color: #ff7f7f; 

        color: white;

    }

    .confirm-btn:hover {

        background-color: #e55e5e;

        transform: translateY(-1px);

    }

    .cancel-btn {

        background-color: #f0f0f0;

        color: #555;

    }

    .cancel-btn:hover {

        background-color: #e0e0e0;

        transform: translateY(-1px);

    }

</style>

</head>



<body>

    <header>

        <div class="left">

            <!-- Thymeleaf: ãƒ›ãƒ¼ãƒ ã¸ã®ãƒªãƒ³ã‚¯ -->

            <a th:href="@{/}" href="/">

                <img src="/images/homebotan.jpg" alt="ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã¸æˆ»ã‚‹" class="home-icon" />

            </a>

            <h1>OshiGiftBox</h1>

        </div>

        <div class="user-links">

            <!-- Thymeleaf: ãƒ¦ãƒ¼ã‚¶ãƒ¼é–¢é€£ãƒšãƒ¼ã‚¸ã¸ã®ãƒªãƒ³ã‚¯ -->

            <a th:href="@{/users/auth_select}">

                <img src="/images/yuza.jpg" alt="ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²" class="user-icon" />

            </a>

        </div>

    </header>

    <main>

        <!-- ğŸ’¡ ã‚«ãƒ¼ãƒˆä¸€è¦§ã«å¤‰æ›´ -->

        <h1>ã‚«ãƒ¼ãƒˆä¸€è¦§</h1>



        <div class="list-card">

            <!-- ğŸ’¡ ã‚«ãƒ¼ãƒˆå†…ã‚¢ã‚¤ãƒ†ãƒ ãƒªã‚¹ãƒˆã«å¤‰æ›´ -->

            <h2>ğŸ›’ ã‚«ãƒ¼ãƒˆå†…ã‚¢ã‚¤ãƒ†ãƒ ãƒªã‚¹ãƒˆ</h2>



            <!-- ğŸ’¡ ãƒ¬ã‚¸ã«é€²ã‚€ãƒœã‚¿ãƒ³ã«å¤‰æ›´ (Spring Bootã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’æƒ³å®š) -->

            <button onclick="proceedToCheckout()" class="checkout-btn">

                ãƒ¬ã‚¸ã«é€²ã‚€ <i class="fas fa-arrow-circle-right"></i>

            </button>



            <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ -->

            <div id="messageBox"></div>

            

            <ul id="productList">

                <p style="text-align: center; color: #7a6fdb; font-weight: 600;">ã‚«ãƒ¼ãƒˆæƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>

            </ul>



            <!-- ğŸ’¡ åˆè¨ˆé‡‘é¡è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’è¿½åŠ  -->

            <div id="totalPriceContainer" style="display: none;">

                <p>å°è¨ˆï¼ˆç¨æŠœï¼‰ï¼š<span id="subTotal">0</span>å††</p>

                <!-- æ¶ˆè²»ç¨ãªã©ã®è¨ˆç®—ã¯ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«ä»»ã›ã‚‹æƒ³å®šã§ã€ã“ã“ã§ã¯ç°¡ç•¥åŒ– -->

                <p>åˆè¨ˆé‡‘é¡ï¼ˆç¨è¾¼ï¼‰ï¼š<span id="grandTotal">0</span>å††</p>

            </div>

        </div>

    </main>



    <!-- Custom Confirmation Modal -->

    <div id="deleteModal" class="modal-overlay">

        <div class="modal-content">

            <!-- ğŸ’¡ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚«ãƒ¼ãƒˆã‚¢ã‚¤ãƒ†ãƒ å‰Šé™¤ç”¨ã«æ›´æ–° -->

            <p id="modalMessage">ã“ã®å•†å“ã‚’ã‚«ãƒ¼ãƒˆã‹ã‚‰å–ã‚Šå‡ºã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</p>

            <div class="modal-actions">

                <button id="modalConfirmBtn" class="confirm-btn">å–ã‚Šå‡ºã™</button>

                <button id="modalCancelBtn" class="cancel-btn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>

            </div>

        </div>

    </div>



    <script>

// å‰Šé™¤å‡¦ç†ã®çŠ¶æ…‹ã‚’ä¿æŒã™ã‚‹ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°

let itemToRemoveId = null;

let itemToRemoveName = null;



// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºé–¢æ•°

function displayMessage(message, type = 'success') {

    const box = document.getElementById('messageBox');

    box.textContent = message;

    box.className = '';

    box.classList.add(type);

    box.style.display = 'block';

    // 3ç§’å¾Œã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¶ˆã™

    setTimeout(() => {

        box.style.display = 'none';

    }, 3000);

}



// ----------------------------------------------------

// ğŸ’¡ ã‚«ãƒ¼ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã®æ•°é‡ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°

// ----------------------------------------------------

async function updateQuantity(id, newQuantity) {

    // æ•°é‡ãŒ0ä»¥ä¸‹ã®å ´åˆã¯å‰Šé™¤ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º

    if (newQuantity <= 0) {

        // ç¾åœ¨ã®ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã‹ã‚‰å•†å“åã‚’å–å¾—ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ãŒå¿…è¦ã ãŒã€

        // ç°¡ç•¥åŒ–ã®ãŸã‚ã€ã“ã“ã§ã¯ã€Œå•†å“ã‚’ã‚«ãƒ¼ãƒˆã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã€ã¨ã„ã†æ±ç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½¿ç”¨

        const currentItem = document.querySelector(`#productList li[data-item-id="${id}"] strong`);

        const name = currentItem ? currentItem.textContent.replace(/^\d+\.\s*/, '') : 'ã“ã®ã‚¢ã‚¤ãƒ†ãƒ ';

        

        // æ•°é‡ãŒ0ä»¥ä¸‹ã«ãªã£ãŸå ´åˆã¯ã€å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º

        showDeleteModal(id, name);

        return; 

    }

    

    // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ã®æ›´æ–°å‡¦ç†ã‚’æƒ³å®š

    try {

        const response = await fetch(`/api/cart/${id}`, {

            method: 'PUT',

            headers: {

                'Content-Type': 'application/json',

            },

            body: JSON.stringify({ quantity: newQuantity })

        });



        if (response.ok) {

            // UIã‚’æ›´æ–°

            // displayMessage(`æ•°é‡ã‚’ ${newQuantity} å€‹ã«æ›´æ–°ã—ã¾ã—ãŸã€‚`, 'success');

            // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æœ€æ–°ã®ã‚«ãƒ¼ãƒˆæƒ…å ±ã‚’å–å¾—ã—ç›´ã™ï¼ˆå°è¨ˆãƒ»åˆè¨ˆãŒå¤‰ã‚ã‚‹ãŸã‚ï¼‰

            fetchAndDisplayCartItems();

        } else if (response.status === 400) {

             const errorText = await response.text();

             displayMessage(`æ•°é‡æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ${errorText}`, 'error');

        } else {

            const errorText = await response.text();

            throw new Error(`[${response.status}] æ•°é‡æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ${errorText}`);

        }

    } catch (err) {

        console.error('æ•°é‡æ›´æ–°ã‚¨ãƒ©ãƒ¼:', err);

        displayMessage(`æ•°é‡æ›´æ–°å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚`, 'error');

    }

}



// +/- ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ãƒãƒ³ãƒ‰ãƒ©

function handleQuantityChange(id, change) {

    const inputElement = document.querySelector(`#productList li[data-item-id="${id}"] .quantity-input`);

    let currentQuantity = parseInt(inputElement.value, 10);

    let newQuantity = currentQuantity + change;



    // UIã‚’å…ˆã«æ›´æ–°ã—ã¦UXã‚’å‘ä¸Šã•ã›ã‚‹ï¼ˆã™ãã«ã‚µãƒ¼ãƒãƒ¼é€šä¿¡ã‚’è¡Œã†ï¼‰

    if (newQuantity >= 1) {

        inputElement.value = newQuantity;

    }

    

    // æ•°é‡ãŒ0ä»¥ä¸‹ã«ãªã£ãŸå ´åˆã‚‚å‡¦ç†ã¯ updateQuantity ã«ä»»ã›ã‚‹

    updateQuantity(id, newQuantity);

}





// ----------------------------------------------------

// ğŸ’¡ ãŠæ°—ã«å…¥ã‚ŠçŠ¶æ…‹ã‚’ãƒˆã‚°ãƒ«ã™ã‚‹é–¢æ•° (å¤‰æ›´ãªã—)

// ----------------------------------------------------

async function toggleFavorite(id, buttonElement) {

    const isFavorited = buttonElement.classList.contains('favorited');

    const method = isFavorited ? 'DELETE' : 'POST'; 

    const actionText = isFavorited ? 'ãŠæ°—ã«å…¥ã‚Šè§£é™¤' : 'ãŠæ°—ã«å…¥ã‚Šç™»éŒ²';



    try {

        // /api/products ã‚’ä½¿ç”¨ã—ã€ã‚«ãƒ¼ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã§ã¯ãªãè£½å“ãã®ã‚‚ã®ã®çŠ¶æ…‹ã‚’æ›´æ–°ã™ã‚‹æƒ³å®š

        const response = await fetch(`/api/products/${id}/favorite`, {

            method: method,

            headers: {

                'Content-Type': 'application/json',

            },

        });



        if (response.ok) {

            buttonElement.classList.toggle('favorited');

            const icon = buttonElement.querySelector('i');

            if (icon) {

                icon.classList.toggle('far', isFavorited); 

                icon.classList.toggle('fas', !isFavorited); 

            }

            displayMessage(`${actionText}ãŒå®Œäº†ã—ã¾ã—ãŸã€‚`, 'success');

        } else if (response.status === 401) {

            displayMessage('ãŠæ°—ã«å…¥ã‚Šæ©Ÿèƒ½ã¯ãƒ­ã‚°ã‚¤ãƒ³å¾Œã«ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™ã€‚', 'error');

        } else {

            const errorText = await response.text();

            throw new Error(`[${response.status}] ${actionText}ã«å¤±æ•—ã—ã¾ã—ãŸ: ${errorText}`);

        }

    } catch (err) {

        console.error('ãŠæ°—ã«å…¥ã‚Šå‡¦ç†ã‚¨ãƒ©ãƒ¼:', err);

        displayMessage(`${actionText}å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚`, 'error');

    }

}





// å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º

function showDeleteModal(id, name) {

    itemToRemoveId = id;

    itemToRemoveName = name;



    const modal = document.getElementById('deleteModal');

    const message = document.getElementById('modalMessage');



    // ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¨­å®š

    message.innerHTML = `<strong>${name}</strong>ã‚’ã‚«ãƒ¼ãƒˆã‹ã‚‰å–ã‚Šå‡ºã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`;

    

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º

    modal.style.display = 'flex';

}



// å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’éè¡¨ç¤º

function hideDeleteModal() {

    document.getElementById('deleteModal').style.display = 'none';

    itemToRemoveId = null;

    itemToRemoveName = null;

}



// å‰Šé™¤ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã¨ãã®å‡¦ç† (ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º)

function removeCartItem(id, name) {

    showDeleteModal(id, name);

}



// ãƒ¢ãƒ¼ãƒ€ãƒ«ã§ã€Œå–ã‚Šå‡ºã™ã€ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã¨ãã®å®Ÿéš›ã®å‰Šé™¤å‡¦ç†

async function confirmDelete() {

    if (itemToRemoveId === null) return;

    

    const id = itemToRemoveId;

    const name = itemToRemoveName;

    

    hideDeleteModal(); // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹



    try {

        // ğŸ’¡ ã‚«ãƒ¼ãƒˆAPIã‚’å©ã

        const response = await fetch(`/api/cart/${id}`, { 

            method: 'DELETE' // ğŸ‘ˆ DELETE ã«å¤‰æ›´

        });



        if (response.ok) {

            // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰è¿”ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æœ¬æ–‡ï¼ˆå•†å“åå…¥ã‚Šã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰ã‚’å–å¾—

            // Spring Bootã§ã¯é€šå¸¸ã¯ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã¾ãŸã¯JSONå¿œç­”ã ãŒã€ã“ã“ã§ã¯ãƒ†ã‚­ã‚¹ãƒˆå¿œç­”ã‚’æƒ³å®š

            const successMessage = await response.text().catch(() => `${name}ã‚’ã‚«ãƒ¼ãƒˆã‹ã‚‰å–ã‚Šå‡ºã—ã¾ã—ãŸã€‚`);

            

            displayMessage(successMessage, 'success'); 

            fetchAndDisplayCartItems(); // ãƒªã‚¹ãƒˆã‚’æ›´æ–°

        } else {

            const errorText = await response.text();

            throw new Error(`[${response.status}] ${errorText || 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼'}`);

        }

    } catch (err) {

        console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', err);

        displayMessage(`å‰Šé™¤å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚è©³ç´°: ${err.message}`, 'error');

    }

}





// ----------------------------------------------------

// ğŸ’¡ ã‚«ãƒ¼ãƒˆãƒªã‚¹ãƒˆã‚’å–å¾—ã—è¡¨ç¤ºã™ã‚‹å‡¦ç†

// ----------------------------------------------------

async function fetchAndDisplayCartItems() {

    const list = document.getElementById('productList');

    const totalContainer = document.getElementById('totalPriceContainer');

    list.innerHTML = '<p style="text-align: center; color: #7a6fdb; font-weight: 600;">ã‚«ãƒ¼ãƒˆæƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>';

    totalContainer.style.display = 'none'; // åˆè¨ˆã‚¨ãƒªã‚¢ã‚’ä¸€æ—¦éè¡¨ç¤º



    // ğŸ’¡ ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ï¼ˆæœ¬æ¥ã¯ã‚µãƒ¼ãƒãƒ¼APIã‹ã‚‰å–å¾—ï¼‰

    let data = [

        /* * ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®å‡¦ç†ã‚’æƒ³å®šã™ã‚‹ãŸã‚ã€

         * ã“ã“ã§ã¯ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã—ã¾ã™ã€‚

         * å®Ÿéš›ã«ã¯Spring Bootã®/api/cartã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‹ã‚‰å–å¾—ã—ã¾ã™ã€‚

         */

        // { id: 101, name: "æ¨ã—è‰²ãƒšãƒ³ãƒ©ã‚¤ãƒˆã‚»ãƒƒãƒˆ", price: 3500, quantity: 2, isFavorited: true, imagePath: "https://placehold.co/60x60/7a6fdb/ffffff?text=Light" },

        // { id: 102, name: "é™å®šãƒ©ã‚¤ãƒ–Tã‚·ãƒ£ãƒ„ (Mã‚µã‚¤ã‚º)", price: 4200, quantity: 1, isFavorited: false, imagePath: "https://placehold.co/60x60/60c5ba/ffffff?text=T-Shirt" },

        // { id: 103, name: "ãƒ©ãƒ³ãƒ€ãƒ ã‚¢ã‚¯ãƒªãƒ«ã‚¹ã‚¿ãƒ³ãƒ‰ (å…¨10ç¨®)", price: 800, quantity: 5, isFavorited: true, imagePath: "https://placehold.co/60x60/a1835d/ffffff?text=Acry" },

    ];

    

    let grandTotal = 0;

    let subTotal = 0;

    const TAX_RATE = 0.10; // 10%



    try {

        // ğŸ’¡ ã‚«ãƒ¼ãƒˆAPIã‚’å©ã

        const response = await fetch('/api/cart'); 

        if (!response.ok) {

            const errorDetail = await response.text();

            throw new Error(`ã‚«ãƒ¼ãƒˆæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${response.status} è©³ç´°: ${errorDetail}`);

        }

        

        data = await response.json();



    } catch (err) {

        console.error('ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', err);

        displayMessage(`ã‚«ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ã€/api/cartã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒæ­£ã—ãå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚`, 'error');

        // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã‚‚ã€ç©ºã®ãƒªã‚¹ãƒˆè¡¨ç¤ºã«é€²ã‚€

    }

    

    list.innerHTML = ''; // ãƒ­ãƒ¼ãƒ‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢



    if (data.length === 0) {

        // ãƒ‡ãƒ¼ã‚¿ãŒç©ºã®å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

        list.innerHTML = '<p style="text-align: center; color: #7a6fdb; font-weight: 600; padding: 15px;">ã‚«ãƒ¼ãƒˆã«ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';

        document.querySelector('.checkout-btn').style.display = 'none';

        return;

    }



    document.querySelector('.checkout-btn').style.display = 'inline-block';



    data.forEach((item, index) => {

        // å°è¨ˆã‚’è¨ˆç®— (æœ¬æ¥ã¯ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§è¨ˆç®—ãƒ»ç®¡ç†ã•ã‚Œã‚‹ã¹ã)

        const itemSubtotal = item.price * item.quantity;

        subTotal += itemSubtotal;



        const li = document.createElement('li');

        li.dataset.itemId = item.id; // æ•°é‡æ›´æ–°ãªã©ã§ä½¿ç”¨ã™ã‚‹ãŸã‚ã«IDã‚’ä»˜ä¸

        

        // ç”»åƒURLãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã®ä»£æ›¿ç”»åƒ

        const imageSrc = item.imagePath 

            ? item.imagePath 

            : `https://placehold.co/60x60/cccccc/ffffff?text=No+Img`;

        

        // ãŠæ°—ã«å…¥ã‚ŠçŠ¶æ…‹ã«åŸºã¥ã„ã¦ã‚¯ãƒ©ã‚¹ã‚’è¨­å®š

        const favoriteClass = item.isFavorited ? 'favorited' : '';

        const iconClass = item.isFavorited ? 'fas' : 'far';



        li.innerHTML = `

            <div class="product-info">

                <!-- ğŸ’¡ å•†å“å -->

                <div class="product-image-container">

                    <img src="${imageSrc}" 

                            alt="${item.name}ã®ç”»åƒ"

                            onerror="this.onerror=null;this.src='https://placehold.co/60x60/cccccc/ffffff?text=No+Img';">

                </div>

                <strong>${index + 1}. ${item.name}</strong>

            </div>

            

            <!-- ğŸ’¡ æ•°é‡ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->

            <div class="quantity-controls">

                <button type="button" onclick="handleQuantityChange(${item.id}, -1)">-</button>

                <input type="number" 

                       class="quantity-input"

                       value="${item.quantity}" 

                       min="1"

                       onchange="updateQuantity(${item.id}, this.value)"

                       aria-label="${item.name}ã®æ•°é‡">

                <button type="button" onclick="handleQuantityChange(${item.id}, 1)">+</button>

            </div>

            

            <!-- ğŸ’¡ ä¾¡æ ¼ã¨å°è¨ˆ -->

            <div class="product-price-subtotal">

                <div style="font-size: 0.8em; color: #777;">${item.price.toLocaleString()}å†† / å€‹</div>

                <div style="font-weight: 700; color: #333; margin-top: 3px;">

                    å°è¨ˆ: ${itemSubtotal.toLocaleString()}å††

                </div>

            </div>



            <!-- ğŸ’¡ ãŠæ°—ã«å…¥ã‚Šãƒœã‚¿ãƒ³ã¨å‰Šé™¤ãƒœã‚¿ãƒ³ -->

            <div class="item-controls">

                <button type="button" 

                        class="favorite-btn ${favoriteClass}" 

                        onclick="toggleFavorite(${item.id}, this)"

                        title="ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ /è§£é™¤">

                    <!-- Font Awesomeã®ãƒãƒ¼ãƒˆã‚¢ã‚¤ã‚³ãƒ³ -->

                    <i class="${iconClass} fa-heart"></i>

                </button>



                <!-- å‰Šé™¤ãƒœã‚¿ãƒ³ã¯ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°ã‚’å‘¼ã³å‡ºã™ -->

                <button type="button" 

                        class="delete-btn"

                        onclick="removeCartItem(${item.id}, '${item.name}')">å‰Šé™¤</button>

            </div>

        `;

        list.appendChild(li);

    });



    // åˆè¨ˆé‡‘é¡ã‚’æ›´æ–°

    const tax = Math.round(subTotal * TAX_RATE);

    grandTotal = subTotal + tax;

    

    document.getElementById('subTotal').textContent = subTotal.toLocaleString();

    document.getElementById('grandTotal').textContent = grandTotal.toLocaleString();

    totalContainer.style.display = 'block';

}



function proceedToCheckout() {

    // Spring Bootã§ãƒ¬ã‚¸ãƒšãƒ¼ã‚¸ã¸ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’æƒ³å®š

    // window.location.href = '/checkout';

    displayMessage('ãƒ¬ã‚¸ã¸é€²ã‚€å‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚ï¼ˆAPIã‚³ãƒ¼ãƒ«ã‚’æƒ³å®šï¼‰', 'success');

}



// ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«å®Ÿè¡Œ

window.onload = function() {

    fetchAndDisplayCartItems();



    // ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š

    document.getElementById('modalConfirmBtn').onclick = confirmDelete;

    document.getElementById('modalCancelBtn').onclick = hideDeleteModal;

    

    // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹

    document.getElementById('deleteModal').addEventListener('click', function(event) {

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è‡ªä½“ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸå ´åˆã¯é–‰ã˜ãªã„

        if (event.target === this) {

            hideDeleteModal();

        }

    });

};

    </script>

</body>

</html>